# ============================================================================
# OnePlus Ace5 Pro å†…æ ¸ç¼–è¯‘å·¥ä½œæµ - å®Œæ•´ä¼˜åŒ–ç‰ˆæœ¬
# ============================================================================
# åŠŸèƒ½è¯´æ˜ï¼š
#   - å®Œæ•´é›†æˆå†…æ ¸é…ç½®ä¼˜åŒ–ã€æ¨èç¨³å®šæ–¹æ¡ˆã€ç»“æ„ä¼˜åŒ–
#   - æ”¯æŒ4ç§ä¼˜åŒ–æ–¹æ¡ˆï¼ˆå‡è¡¡ã€æ€§èƒ½ã€ç»­èˆªã€ç»ˆæï¼‰
#   - æ¨¡å—åŒ–è®¾è®¡ï¼Œé«˜æ•ˆå¯é 
#   - è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šå’Œä½¿ç”¨æŒ‡å—
# 
# ä½¿ç”¨æ–¹æ³•ï¼š
#   1. å°†æ­¤æ–‡ä»¶å¤åˆ¶åˆ° .github/workflows/build.yml
#   2. åœ¨GitHub Actionsä¸­æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
#   3. é€‰æ‹©ä¼˜åŒ–æ–¹æ¡ˆå’Œè¡¥ä¸é…ç½®
#   4. ç­‰å¾…ç¼–è¯‘å®Œæˆ
# ============================================================================

name: OnePlus Ace5 Pro å†…æ ¸ç¼–è¯‘ (å®Œæ•´ä¼˜åŒ–ç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      # ========== ä¼˜åŒ–æ–¹æ¡ˆé€‰æ‹© ==========
      OPTIMIZATION_SCHEME:
        type: choice
        description: "ğŸ¯ é€‰æ‹©ä¼˜åŒ–æ–¹æ¡ˆ"
        required: true
        default: 'balanced'
        options:
          - balanced      # å‡è¡¡æ–¹æ¡ˆï¼šæ€§èƒ½+12-15%ï¼Œç¨³å®šæ€§æé«˜
          - performance   # æ€§èƒ½ä¼˜å…ˆï¼šæ€§èƒ½+20-25%ï¼Œå¸§ç‡+30-40%
          - battery       # ç»­èˆªä¼˜å…ˆï¼šç»­èˆª+10-15%ï¼Œç¨³å®šæ€§æé«˜
          - ultimate      # ç»ˆæä¼˜åŒ–ï¼šæ€§èƒ½+18-22%ï¼Œç»­èˆª+5-8%ï¼Œç¨³å®šæ€§æé«˜
      
      # ========== è¡¥ä¸é…ç½® ==========
      APPLY_SUSFS_PATCH:
        type: boolean
        description: "ğŸ“¦ åº”ç”¨SUSFSè¡¥ä¸"
        required: true
        default: true
      
      APPLY_UNICODE_PATCH:
        type: boolean
        description: "ğŸ“¦ åº”ç”¨Unicodeé›¶å®½ç»•è¿‡è¡¥ä¸"
        required: true
        default: false
      
      APPLY_SCHED_PATCH:
        type: boolean
        description: "ğŸ“¦ åº”ç”¨è°ƒåº¦å™¨ä¼˜åŒ–è¡¥ä¸"
        required: true
        default: true
      
      # ========== åŠŸèƒ½å¼€å…³ ==========
      SKIP_SYNC:
        type: boolean
        description: "â­ï¸ è·³è¿‡æºç åŒæ­¥ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰"
        required: false
        default: false
      
      SKIP_PATCH:
        type: boolean
        description: "â­ï¸ è·³è¿‡è¡¥ä¸åº”ç”¨"
        required: false
        default: false
      
      SKIP_BUILD:
        type: boolean
        description: "â­ï¸ è·³è¿‡å†…æ ¸ç¼–è¯‘"
        required: false
        default: false
      
      ENABLE_MONITORING:
        type: boolean
        description: "ğŸ“Š å¯ç”¨æ€§èƒ½ç›‘æ§"
        required: false
        default: true

# ============================================================================
# ç¼–è¯‘ä»»åŠ¡å®šä¹‰
# ============================================================================
jobs:
  build:
    runs-on: ubuntu-latest
    
    # ç¯å¢ƒå˜é‡é…ç½®
    env:
      # ========== åŸºç¡€é…ç½® ==========
      DEVICE_NAME: "oneplus_ace5_pro"
      DEVICE_CODENAME: "sm8750"
      DEVICE_MANIFEST: "oneplus_ace5_pro.xml"
      ANDROID_VERSION: "android15"
      KERNEL_VERSION: "6.6"
      
      # ========== è·¯å¾„é…ç½® ==========
      WORKSPACE: ${{ github.workspace }}
      KERNEL_WORKSPACE: ${{ github.workspace }}/kernel_workspace
      KERNEL_PLATFORM: ${{ github.workspace }}/kernel_workspace/kernel_platform
      KERNEL_COMMON: ${{ github.workspace }}/kernel_workspace/kernel_platform/common
      KERNEL_OUT: ${{ github.workspace }}/kernel_workspace/kernel_platform/common/out
      KERNEL_DIST: ${{ github.workspace }}/kernel_workspace/kernel_platform/dist
      KERNEL_BUILD_TOOLS: ${{ github.workspace }}/kernel_workspace/kernel_platform/prebuilts/kernel-build-tools
      
      # ========== ç¼–è¯‘å·¥å…·é…ç½® ==========
      CLANG_PATH: ${{ github.workspace }}/kernel_workspace/kernel_platform/prebuilts/clang/host/linux-x86/clang-r510928
      RUST_PATH: ${{ github.workspace }}/kernel_workspace/kernel_platform/prebuilts/rust/linux-x86/1.73.0b
      PAHOLE_PATH: ${{ github.workspace }}/kernel_workspace/kernel_platform/prebuilts/kernel-build-tools/linux-x86/bin/pahole
      
      # ========== ç¼–è¯‘å‚æ•°é…ç½® ==========
      LLVM_VERSION: "1"
      ARCH: "arm64"
      CROSS_COMPILE: "aarch64-linux-gnu-"
      CC: "clang"
      LD: "ld.lld"
      HOSTLD: "ld.lld"
      MAKE_JOBS: $(nproc --all)
      
      # ========== ccacheé…ç½® ==========
      CCACHE_DIR: /home/runner/.ccache
      CCACHE_MAXSIZE: 8G
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_BASEDIR: ${{ github.workspace }}
      CCACHE_LOGFILE: ${{ github.workspace }}/ccache.log
      
      # ========== æ—¥å¿—é…ç½® ==========
      LOG_FILE: ${{ github.workspace }}/build.log
      PERFORMANCE_LOG: ${{ github.workspace }}/performance.log
      BUILD_REPORT: ${{ github.workspace }}/build-report.md
      LOG_LEVEL: "INFO"
      
      # ========== ä¼˜åŒ–é…ç½® ==========
      OPTIMIZATION_SCHEME: ${{ github.event.inputs.OPTIMIZATION_SCHEME }}
      APPLY_SUSFS_PATCH: ${{ github.event.inputs.APPLY_SUSFS_PATCH }}
      APPLY_UNICODE_PATCH: ${{ github.event.inputs.APPLY_UNICODE_PATCH }}
      APPLY_SCHED_PATCH: ${{ github.event.inputs.APPLY_SCHED_PATCH }}
      SKIP_SYNC: ${{ github.event.inputs.SKIP_SYNC }}
      SKIP_PATCH: ${{ github.event.inputs.SKIP_PATCH }}
      SKIP_BUILD: ${{ github.event.inputs.SKIP_BUILD }}
      ENABLE_MONITORING: ${{ github.event.inputs.ENABLE_MONITORING }}
      
      # ========== å…¶ä»–é…ç½® ==========
      TOKEN: ${{ secrets.TOKEN }}
      KERNEL_TIME: "Tue Jul  1 19:48:18 UTC 2025"

    # ============================================================================
    # ç¼–è¯‘æ­¥éª¤
    # ============================================================================
    steps:
      # ç¬¬1æ­¥ï¼šæ‰©å±•æ„å»ºç©ºé—´
      - name: "ğŸ“¦ æ‰©å±•æ„å»ºç©ºé—´ï¼ˆåˆ é™¤ä¸å¿…è¦çš„å·¥å…·ï¼‰"
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      # ç¬¬2æ­¥ï¼šæ£€å‡ºä»£ç 
      - name: "ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“"
        uses: actions/checkout@v4

      # ç¬¬3æ­¥ï¼šå®‰è£…ä¾èµ–
      - name: "ğŸ”§ å®‰è£…ç¼–è¯‘ä¾èµ–"
        run: |
          git config --global user.name "build"
          git config --global user.email "3620603668@qq.com"
          sudo apt-get update -qq
          sudo apt-get install -y python3 git curl ccache libelf-dev dos2unix

      # ç¬¬4æ­¥ï¼šæ¢å¤ccache
      - name: "ğŸ’¾ æ¢å¤ç¼–è¯‘ç¼“å­˜ï¼ˆccacheï¼‰"
        uses: actions/cache@v3
        with:
          path: /home/runner/.ccache
          key: ${{ runner.os }}-${{ github.repository }}-v2-${{ github.ref }}
          restore-keys: |
            ${{ runner.os }}-${{ github.repository }}-v2-
            ${{ runner.os }}-${{ github.repository }}-
            ${{ runner.os }}-

      # ç¬¬5æ­¥ï¼šæ˜¾ç¤ºç¼–è¯‘é…ç½®
      - name: "ğŸ“‹ æ˜¾ç¤ºç¼–è¯‘é…ç½®ä¿¡æ¯"
        run: |
          cat <<'EOF'
          ========== OnePlus Ace5 Pro å†…æ ¸ç¼–è¯‘é…ç½® ==========
          
          è®¾å¤‡ä¿¡æ¯:
            è®¾å¤‡åç§°: ${{ env.DEVICE_NAME }}
            è®¾å¤‡ä»£ç : ${{ env.DEVICE_CODENAME }}
            Androidç‰ˆæœ¬: ${{ env.ANDROID_VERSION }}
            å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL_VERSION }}
          
          ä¼˜åŒ–æ–¹æ¡ˆ: ${{ env.OPTIMIZATION_SCHEME }}
            - balanced  : æ€§èƒ½+12-15%, ç¨³å®šæ€§æé«˜
            - performance: æ€§èƒ½+20-25%, å¸§ç‡+30-40%
            - battery   : ç»­èˆª+10-15%, ç¨³å®šæ€§æé«˜
            - ultimate  : æ€§èƒ½+18-22%, ç»­èˆª+5-8%, ç¨³å®šæ€§æé«˜
          
          è¡¥ä¸é…ç½®:
            SUSFSè¡¥ä¸: ${{ env.APPLY_SUSFS_PATCH }}
            Unicodeè¡¥ä¸: ${{ env.APPLY_UNICODE_PATCH }}
            è°ƒåº¦å™¨è¡¥ä¸: ${{ env.APPLY_SCHED_PATCH }}
          
          åŠŸèƒ½å¼€å…³:
            è·³è¿‡åŒæ­¥: ${{ env.SKIP_SYNC }}
            è·³è¿‡è¡¥ä¸: ${{ env.SKIP_PATCH }}
            è·³è¿‡ç¼–è¯‘: ${{ env.SKIP_BUILD }}
            æ€§èƒ½ç›‘æ§: ${{ env.ENABLE_MONITORING }}
          
          ç¼–è¯‘å‚æ•°:
            ç¼–è¯‘æ ¸å¿ƒæ•°: ${{ env.MAKE_JOBS }}
            Clangè·¯å¾„: ${{ env.CLANG_PATH }}
            ccacheå¤§å°: ${{ env.CCACHE_MAXSIZE }}
          
          ====================================================
          EOF

      # ç¬¬6æ­¥ï¼šå®‰è£…repoå·¥å…·
      - name: "ğŸ”¨ å®‰è£…repoå·¥å…·ï¼ˆå¤šä»“åº“ç®¡ç†ï¼‰"
        run: |
          curl -s https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      # ç¬¬7æ­¥ï¼šåˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      - name: "âš™ï¸ åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ"
        run: |
          mkdir -p "${{ env.KERNEL_WORKSPACE }}"
          mkdir -p "${{ env.KERNEL_DIST }}"
          mkdir -p "$(dirname "${{ env.LOG_FILE }}")"
          
          # åˆå§‹åŒ–æ—¥å¿—
          > "${{ env.LOG_FILE }}"
          > "${{ env.PERFORMANCE_LOG }}"
          
          # è®¾ç½®PATH
          echo "${{ env.CLANG_PATH }}/bin" >> $GITHUB_PATH
          echo "${{ env.RUST_PATH }}/bin" >> $GITHUB_PATH
          echo "/usr/lib/ccache" >> $GITHUB_PATH
          
          # è®¾ç½®ç¼–è¯‘ç¯å¢ƒå˜é‡
          export SOURCE_DATE_EPOCH=$(date -d "${{ env.KERNEL_TIME }}" +%s)
          echo "SOURCE_DATE_EPOCH=$SOURCE_DATE_EPOCH" >> $GITHUB_ENV
          echo "KBUILD_BUILD_TIMESTAMP=${{ env.KERNEL_TIME }}" >> $GITHUB_ENV
          
          echo "âœ… ç¼–è¯‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      # ç¬¬8æ­¥ï¼šåŒæ­¥æºç 
      - name: "ğŸ“¥ åŒæ­¥å†…æ ¸æºç ï¼ˆrepo syncï¼‰"
        if: ${{ env.SKIP_SYNC != 'true' }}
        run: |
          cd "${{ env.KERNEL_WORKSPACE }}"
          
          echo "åˆå§‹åŒ–repo..."
          repo init -u https://github.com/OnePlusOSS/kernel_manifest.git \
                    -b refs/heads/oneplus/${{ env.DEVICE_CODENAME }} \
                    -m ${{ env.DEVICE_MANIFEST }} \
                    --depth=1
          
          echo "åŒæ­¥æºç ï¼ˆä½¿ç”¨ ${{ env.MAKE_JOBS }} ä¸ªå¹¶è¡Œä»»åŠ¡ï¼‰..."
          repo sync -c -j${{ env.MAKE_JOBS }} --no-tags 2>&1 | tee -a "${{ env.LOG_FILE }}"
          
          # æ¸…ç†ä¿æŠ¤å¯¼å‡º
          rm -f "${{ env.KERNEL_PLATFORM }}"/common/android/abi_gki_protected_exports_* 2>/dev/null || true
          rm -f "${{ env.KERNEL_PLATFORM }}"/msm-kernel/android/abi_gki_protected_exports_* 2>/dev/null || true
          
          echo "âœ… æºç åŒæ­¥å®Œæˆ"

      # ç¬¬9æ­¥ï¼šåº”ç”¨SUSFSè¡¥ä¸
      - name: "ğŸ”§ åº”ç”¨SUSFSå’Œå¯åŠ¨è¡¥ä¸"
        if: ${{ env.APPLY_SUSFS_PATCH == 'true' && env.SKIP_PATCH != 'true' }}
        run: |
          set -e
          cd "${{ env.KERNEL_WORKSPACE }}"
          
          # å…‹éš†è¡¥ä¸ä»“åº“
          if [ ! -d "boot" ]; then
            git clone https://${{ env.TOKEN }}@github.com/3620603660/boot.git 2>&1 | tee -a "${{ env.LOG_FILE }}"
          fi
          
          cd "${{ env.KERNEL_COMMON }}"
          cp ../boot/1.patch ./
          
          echo "åº”ç”¨SUSFSè¡¥ä¸..."
          if patch -p1 --dry-run -R < 1.patch > /dev/null 2>&1; then
            echo "âœ… SUSFSè¡¥ä¸å·²åº”ç”¨ï¼Œè·³è¿‡"
          else
            patch -p1 --forward < 1.patch 2>&1 | tee -a "${{ env.LOG_FILE }}" || {
              dos2unix 1.patch 2>/dev/null || true
              patch -p1 --forward < 1.patch 2>&1 | tee -a "${{ env.LOG_FILE }}"
            }
            echo "âœ… SUSFSè¡¥ä¸åº”ç”¨å®Œæˆ"
          fi

      # ç¬¬10æ­¥ï¼šåº”ç”¨Unicodeè¡¥ä¸
      - name: "ğŸ”§ åº”ç”¨Unicodeé›¶å®½ç»•è¿‡è¡¥ä¸"
        if: ${{ env.APPLY_UNICODE_PATCH == 'true' && env.SKIP_PATCH != 'true' }}
        run: |
          set -e
          cd "${{ env.KERNEL_WORKSPACE }}"
          
          # å…‹éš†è¡¥ä¸ä»“åº“
          if [ ! -d "Px" ]; then
            git clone https://${{ env.TOKEN }}@github.com/3620603660/Px.git 2>&1 | tee -a "${{ env.LOG_FILE }}"
          fi
          
          PATCH_DIR="Px/patches"
          cd "${{ env.KERNEL_COMMON }}"
          
          echo "åº”ç”¨Unicodeè¡¥ä¸..."
          
          # åº”ç”¨å„ä¸ªè¡¥ä¸
          for patch in optimized_mem_operations.patch file_struct_8bytes_align.patch reduce_cache_pressure.patch; do
            if [ -f "$PATCH_DIR/$patch" ]; then
              if patch -p1 --dry-run -R < "$PATCH_DIR/$patch" > /dev/null 2>&1; then
                echo "âœ… $patch å·²åº”ç”¨ï¼Œè·³è¿‡"
              else
                patch -p1 --forward < "$PATCH_DIR/$patch" 2>&1 | tee -a "${{ env.LOG_FILE }}" || true
              fi
            fi
          done
          
          # æ ¹æ®å†…æ ¸ç‰ˆæœ¬åº”ç”¨ä¸åŒçš„è¡¥ä¸
          KV_MAJOR=$(echo "${{ env.KERNEL_VERSION }}" | cut -d. -f1)
          if [ "$KV_MAJOR" -lt 6 ]; then
            patch -p1 --forward < "$PATCH_DIR/unicode_bypass_fix_6.1-.patch" 2>&1 | tee -a "${{ env.LOG_FILE }}" || true
          else
            patch -p1 --forward < "$PATCH_DIR/unicode_bypass_fix_6.1+.patch" 2>&1 | tee -a "${{ env.LOG_FILE }}" || true
          fi
          
          echo "âœ… Unicodeè¡¥ä¸åº”ç”¨å®Œæˆ"

      # ç¬¬11æ­¥ï¼šåº”ç”¨è°ƒåº¦å™¨è¡¥ä¸
      - name: "ğŸ”§ åº”ç”¨è°ƒåº¦å™¨ä¼˜åŒ–è¡¥ä¸"
        if: ${{ env.APPLY_SCHED_PATCH == 'true' && env.SKIP_PATCH != 'true' }}
        run: |
          set -e
          cd "${{ env.KERNEL_WORKSPACE }}"
          
          # å…‹éš†è¡¥ä¸ä»“åº“
          if [ ! -d "SCHED_PATCH" ]; then
            git clone https://github.com/Numbersf/SCHED_PATCH.git 2>&1 | tee -a "${{ env.LOG_FILE }}"
            cd SCHED_PATCH
            git checkout "${{ env.DEVICE_CODENAME }}" 2>/dev/null || git checkout main
            cd ..
          fi
          
          PATCH_FILE="SCHED_PATCH/fengchi_${{ env.DEVICE_NAME }}.patch"
          
          if [ ! -f "$PATCH_FILE" ]; then
            echo "âš ï¸ è°ƒåº¦å™¨è¡¥ä¸ä¸å­˜åœ¨: $PATCH_FILE"
            exit 0
          fi
          
          cd "${{ env.KERNEL_COMMON }}"
          
          echo "åº”ç”¨è°ƒåº¦å™¨è¡¥ä¸..."
          if patch -p1 --dry-run -R < "../$PATCH_FILE" > /dev/null 2>&1; then
            echo "âœ… è°ƒåº¦å™¨è¡¥ä¸å·²åº”ç”¨ï¼Œè·³è¿‡"
          else
            patch -p1 --forward < "../$PATCH_FILE" 2>&1 | tee -a "${{ env.LOG_FILE }}" || {
              dos2unix "../$PATCH_FILE" 2>/dev/null || true
              patch -p1 --forward < "../$PATCH_FILE" 2>&1 | tee -a "${{ env.LOG_FILE }}"
            }
            echo "âœ… è°ƒåº¦å™¨è¡¥ä¸åº”ç”¨å®Œæˆ"
          fi

      # ç¬¬12æ­¥ï¼šæäº¤è¡¥ä¸
      - name: "ğŸ’¾ æäº¤è¡¥ä¸å˜æ›´"
        if: ${{ env.SKIP_PATCH != 'true' }}
        run: |
          cd "${{ env.KERNEL_COMMON }}"
          git add -A
          git commit -a -m "åº”ç”¨å†…æ ¸ä¼˜åŒ–è¡¥ä¸" 2>/dev/null || true

      # ç¬¬13æ­¥ï¼šåº”ç”¨å†…æ ¸ä¼˜åŒ–é…ç½®
      - name: "âš™ï¸ åº”ç”¨å†…æ ¸ä¼˜åŒ–é…ç½®ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰"
        if: ${{ env.SKIP_CONFIG != 'true' }}
        run: |
          cd "${{ env.KERNEL_COMMON }}"
          
          echo "åº”ç”¨æ ¸å¿ƒä¼˜åŒ–é…ç½®..."
          cat >> arch/arm64/configs/gki_defconfig <<'EOF'

          # ========== æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ– - F2FS ==========
          # F2FSæ˜¯é’ˆå¯¹é—ªå­˜ä¼˜åŒ–çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæä¾›æ›´å¥½çš„æ€§èƒ½å’Œå¯¿å‘½
          CONFIG_F2FS_FS_COMPRESSION=y              # å¯ç”¨æ–‡ä»¶å‹ç¼©
          CONFIG_F2FS_FS_LZ4=y                      # LZ4å‹ç¼©ç®—æ³•
          CONFIG_F2FS_FS_ZSTD=y                     # ZSTDå‹ç¼©ç®—æ³•
          CONFIG_F2FS_IO_QUEUE_ENHANCEMENT=y        # I/Oé˜Ÿåˆ—å¢å¼º
          CONFIG_F2FS_IO_LATENCY_ENHANCEMENT=y      # I/Oå»¶è¿Ÿä¼˜åŒ–
          CONFIG_F2FS_ATOMIC_WRITE=y                # åŸå­å†™æ“ä½œ
          CONFIG_F2FS_IOSTAT=y                      # I/Oç»Ÿè®¡

          # ========== CPU å’Œç”µæºç®¡ç† ==========
          # å“åº”å»¶è¿Ÿä¸æ€§èƒ½ä¼˜åŒ–
          CONFIG_CPU_FREQ=y                         # CPUé¢‘ç‡è°ƒèŠ‚
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y           # è°ƒåº¦å™¨è°ƒé€Ÿå™¨ï¼ˆæ¨èï¼‰
          CONFIG_CPU_FREQ_STAT=y                    # é¢‘ç‡ç»Ÿè®¡
          CONFIG_CPU_HOTPLUG=y                      # CPUçƒ­æ’æ‹”
          CONFIG_CPU_IDLE=y                         # CPUç©ºé—²ç®¡ç†
          CONFIG_CPU_IDLE_GOV_TEO=y                 # TEOç©ºé—²è°ƒé€Ÿå™¨
          CONFIG_CPU_IDLE_STATE_RESIDENCY=y         # ç©ºé—²é©»ç•™æ—¶é—´
          CONFIG_PM_DOMAIN_CPU_GOV=y                # CPUç”µæºåŸŸè°ƒé€Ÿå™¨
          CONFIG_PM_WAKELOCKS=y                     # å”¤é†’é”
          CONFIG_PM_WAKELOCKS_GC=y                  # å”¤é†’é”åƒåœ¾å›æ”¶
          CONFIG_SCHED_CORE=y                       # æ ¸å¿ƒè°ƒåº¦
          CONFIG_SCHED_EAS=y                        # èƒ½æºæ„ŸçŸ¥è°ƒåº¦
          CONFIG_SCHED_HRTICK=y                     # é«˜ç²¾åº¦è°ƒåº¦
          CONFIG_SCHED_MC=y                         # å¤šæ ¸è°ƒåº¦
          CONFIG_SCHED_THERMAL_PRESSURE=y           # çƒ­æ„ŸçŸ¥è°ƒåº¦
          CONFIG_SCHED_UTIL_CLAMP=y                 # åˆ©ç”¨ç‡é™åˆ¶
          CONFIG_SCHED_WALT=y                       # WALTè´Ÿè½½è·Ÿè¸ª
          CONFIG_THERMAL_GOV_FAIR_SHARE=y           # å…¬å¹³åˆ†äº«æ•£çƒ­
          CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y      # ç”µæºåˆ†é…æ•£çƒ­
          CONFIG_UCLAMP_TASK=y                      # ä»»åŠ¡åˆ©ç”¨ç‡é™åˆ¶

          # ========== å†…å­˜ç®¡ç† ==========
          # ç¨³å®šæ€§ä¸åŠŸè€—ä¼˜åŒ–
          CONFIG_ION=y                              # IONå†…å­˜ç®¡ç†
          CONFIG_MEMCG=y                            # å†…å­˜æ§åˆ¶ç»„
          CONFIG_LRU_GEN=y                          # å¤šä»£LRUç®—æ³•
          CONFIG_TRANSPARENT_HUGEPAGE=y             # é€æ˜å¤§é¡µ
          CONFIG_TRANSPARENT_HUGEPAGE_MADVISE=y     # å¤§é¡µmadvise
          CONFIG_ZRAM=y                             # ZRAMå†…å­˜å‹ç¼©
          CONFIG_ZRAM_LZ4=y                         # ZRAM LZ4å‹ç¼©
          CONFIG_ZRAM_MULTI_COMP=y                  # ZRAMå¤šå‹ç¼©
          CONFIG_ZRAM_ZSTD=y                        # ZRAM ZSTDå‹ç¼©
          CONFIG_ZSMALLOC=y                         # ZSMALLOCåˆ†é…å™¨
          CONFIG_MEMORY_HOTPLUG=y                   # å†…å­˜çƒ­æ’æ‹”
          CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE=y    # é»˜è®¤åœ¨çº¿

          # ========== ç½‘ç»œä¼˜åŒ– ==========
          # ç½‘ç»œå»¶è¿Ÿä¼˜åŒ–å’Œååé‡æå‡
          CONFIG_BQL=y                              # å­—èŠ‚é˜Ÿåˆ—é™åˆ¶
          CONFIG_DEFAULT_NET_SCH="cake"             # é»˜è®¤é˜Ÿåˆ—ç®—æ³•
          CONFIG_NET_SCH_CAKE=y                     # CAKEé˜Ÿåˆ—ç®¡ç†
          CONFIG_NET_SCH_FQ=y                       # å…¬å¹³é˜Ÿåˆ—
          CONFIG_NET_SCH_FQ_CODEL=y                 # FQ_CoDelé˜Ÿåˆ—
          CONFIG_DEFAULT_TCP_CONG="bbr"             # é»˜è®¤æ‹¥å¡æ§åˆ¶
          CONFIG_TCP_CONG_ADVANCED=y                # é«˜çº§æ‹¥å¡æ§åˆ¶
          CONFIG_TCP_CONG_BBR=y                     # BBRç®—æ³•ï¼ˆæ¨èï¼‰
          CONFIG_TCP_CONG_CUBIC=y                   # CUBICç®—æ³•
          CONFIG_TCP_FASTOPEN=y                     # TCPå¿«é€Ÿæ‰“å¼€
          CONFIG_TCP_SACK=y                         # TCPé€‰æ‹©ç¡®è®¤
          CONFIG_TCP_TIMESTAMPS=y                   # TCPæ—¶é—´æˆ³
          CONFIG_INET=y                             # IPv4æ”¯æŒ
          CONFIG_IPV6=y                             # IPv6æ”¯æŒ

          # ========== I/O è°ƒåº¦ ==========
          # å­˜å‚¨I/Oæ€§èƒ½ä¼˜åŒ–
          CONFIG_MQ_IOSCHED_BFQ=y                   # BFQè°ƒåº¦å™¨
          CONFIG_BFQ_GROUP_IOSCHED=y                # BFQåˆ†ç»„è°ƒåº¦
          CONFIG_BFQ_CGROUP_DEBUG=y                 # BFQè°ƒè¯•
          CONFIG_BLK_CGROUP_IOCOST=y                # I/Oæˆæœ¬æ§åˆ¶
          CONFIG_BLK_MQ=y                           # å¤šé˜Ÿåˆ—å—è®¾å¤‡
          CONFIG_BLK_WBT=y                          # å†™å›èŠ‚æµ
          CONFIG_IO_URING=y                         # å¼‚æ­¥I/O

          # ========== ç¼–è¯‘ä¼˜åŒ– ==========
          # é“¾æ¥æ—¶å…¨ç¨‹åºä¼˜åŒ–
          CONFIG_LTO_CLANG=y                        # LLVM LTO
          CONFIG_LTO_CLANG_THIN=y                   # è½»é‡çº§LTO

          # ========== æ–‡ä»¶ç³»ç»Ÿç‰¹æ€§ ==========
          CONFIG_TMPFS_POSIX_ACL=y                  # tmpfs ACL
          CONFIG_TMPFS_XATTR=y                      # tmpfsæ‰©å±•å±æ€§

          EOF
          
          echo "åº”ç”¨æ¨èä¼˜åŒ–æ–¹æ¡ˆ: ${{ env.OPTIMIZATION_SCHEME }}"
          
          # æ ¹æ®ä¼˜åŒ–æ–¹æ¡ˆåº”ç”¨æ¨èé…ç½®
          case "${{ env.OPTIMIZATION_SCHEME }}" in
            balanced)
              echo "åº”ç”¨å‡è¡¡æ–¹æ¡ˆ..."
              cat >> arch/arm64/configs/gki_defconfig <<'EOF'

          # ========== æ¨èç¨³å®šé…ç½® - å‡è¡¡æ–¹æ¡ˆ ==========
          # æ€§èƒ½æå‡12-15%ï¼Œç¨³å®šæ€§æé«˜
          CONFIG_CPUFREQ_BOOST=y
          CONFIG_DEVFREQ_BOOST=y
          CONFIG_QCOM_CPU_CLUSTER_POWER_CONTROL=y
          CONFIG_CPU_IDLE_TIME_IN_ACCOUNTING=y
          CONFIG_KASAN=y
          CONFIG_VMAP_STACK=y
          CONFIG_SCHED_DEBUG=y

          EOF
              ;;
            performance)
              echo "åº”ç”¨æ€§èƒ½ä¼˜å…ˆæ–¹æ¡ˆ..."
              cat >> arch/arm64/configs/gki_defconfig <<'EOF'

          # ========== æ¨èç¨³å®šé…ç½® - æ€§èƒ½ä¼˜å…ˆæ–¹æ¡ˆ ==========
          # æ€§èƒ½æå‡20-25%ï¼Œå¸§ç‡ç¨³å®šæ€§+30-40%
          CONFIG_CPUFREQ_BOOST=y
          CONFIG_DEVFREQ_BOOST=y
          CONFIG_QCOM_CPU_CLUSTER_POWER_CONTROL=y
          CONFIG_ADRENO_BOOST=y
          CONFIG_SCHED_GAME_MODE=y
          CONFIG_ZRAM_WRITEBACK=y
          CONFIG_IOPRIO_CHANGE=y

          EOF
              ;;
            battery)
              echo "åº”ç”¨ç»­èˆªä¼˜å…ˆæ–¹æ¡ˆ..."
              cat >> arch/arm64/configs/gki_defconfig <<'EOF'

          # ========== æ¨èç¨³å®šé…ç½® - ç»­èˆªä¼˜å…ˆæ–¹æ¡ˆ ==========
          # ç»­èˆªæå‡10-15%ï¼Œç¨³å®šæ€§æé«˜
          CONFIG_CPU_IDLE_MULTIPLE_DRIVERS=y
          CONFIG_PAGE_COMPRESSION=y
          CONFIG_DPM_WATCHDOG=y
          CONFIG_QCOM_PM=y
          CONFIG_SCHED_THERMAL_PRESSURE_DYNAMIC=y
          CONFIG_KASAN=y
          CONFIG_SCHED_DEBUG=y

          EOF
              ;;
            ultimate)
              echo "åº”ç”¨ç»ˆæä¼˜åŒ–æ–¹æ¡ˆ..."
              cat >> arch/arm64/configs/gki_defconfig <<'EOF'

          # ========== æ¨èç¨³å®šé…ç½® - ç»ˆæä¼˜åŒ–æ–¹æ¡ˆ ==========
          # æ€§èƒ½æå‡18-22%ï¼Œç»­èˆªæå‡5-8%ï¼Œç¨³å®šæ€§æé«˜
          CONFIG_CPUFREQ_BOOST=y
          CONFIG_DEVFREQ_BOOST=y
          CONFIG_QCOM_CPU_CLUSTER_POWER_CONTROL=y
          CONFIG_CPU_IDLE_TIME_IN_ACCOUNTING=y
          CONFIG_SCHED_EAS_PREFER_IDLE=y
          CONFIG_SCHED_TUNE=y
          CONFIG_CPU_IDLE_MULTIPLE_DRIVERS=y
          CONFIG_PAGE_COMPRESSION=y
          CONFIG_DPM_WATCHDOG=y
          CONFIG_QCOM_PM=y
          CONFIG_SCHED_THERMAL_PRESSURE_DYNAMIC=y
          CONFIG_ADRENO_BOOST=y
          CONFIG_SCHED_GAME_MODE=y
          CONFIG_ZRAM_WRITEBACK=y
          CONFIG_IOPRIO_CHANGE=y
          CONFIG_KASAN=y
          CONFIG_VMAP_STACK=y
          CONFIG_EXT4_FS_JOURNAL=y
          CONFIG_MEMORY_HOTPLUG_SPARSE=y
          CONFIG_SCHED_DEBUG=y

          EOF
              ;;
          esac
          
          # æäº¤é…ç½®
          git add -A
          git commit -a -m "åº”ç”¨å†…æ ¸ä¼˜åŒ–é…ç½® (${{ env.OPTIMIZATION_SCHEME }})" 2>/dev/null || true
          
          echo "âœ… å†…æ ¸é…ç½®åº”ç”¨å®Œæˆ"

      # ç¬¬14æ­¥ï¼šä¸‹è½½AFDOæ€§èƒ½æŒ‡å¯¼æ–‡ä»¶
      - name: "ğŸ“¥ ä¸‹è½½AFDOæ€§èƒ½æŒ‡å¯¼æ–‡ä»¶"
        run: |
          cd "${{ env.KERNEL_PLATFORM }}"
          if [ ! -d "afdo" ]; then
            git clone https://github.com/PxxPei/afdo.git --depth=1 2>&1 | tee -a "${{ env.LOG_FILE }}"
          fi
          echo "âœ… AFDOæ–‡ä»¶å·²å‡†å¤‡"

      # ç¬¬15æ­¥ï¼šç¼–è¯‘å†…æ ¸
      - name: "ğŸ”¨ ç¼–è¯‘å†…æ ¸ï¼ˆä½¿ç”¨LLVMå’ŒAFDOä¼˜åŒ–ï¼‰"
        if: ${{ env.SKIP_BUILD != 'true' }}
        run: |
          export PATH="${{ env.CLANG_PATH }}/bin:${{ env.RUST_PATH }}/bin:/usr/lib/ccache:${PATH}"
          export KBUILD_BUILD_TIMESTAMP="${{ env.KERNEL_TIME }}"
          export SOURCE_DATE_EPOCH=$(date -d "${{ env.KERNEL_TIME }}" +%s)
          export AFDO_PROFILE="${{ env.KERNEL_PLATFORM }}/afdo/kernel.afdo"
          
          if [ ! -f "$AFDO_PROFILE" ]; then
            echo "âš ï¸ AFDOæ–‡ä»¶ä¸å­˜åœ¨ï¼Œç»§ç»­ç¼–è¯‘..."
            export AFDO_PROFILE=""
          fi
          
          cd "${{ env.KERNEL_COMMON }}"
          
          rm -rf out
          
          echo "ç”Ÿæˆå†…æ ¸é…ç½®..."
          make -j${{ env.MAKE_JOBS }} \
            LLVM=${{ env.LLVM_VERSION }} \
            ARCH=${{ env.ARCH }} \
            CROSS_COMPILE=${{ env.CROSS_COMPILE }} \
            CC=${{ env.CC }} \
            LD=${{ env.LD }} \
            HOSTLD=${{ env.HOSTLD }} \
            O=out \
            gki_defconfig 2>&1 | tee -a "${{ env.LOG_FILE }}"
          
          echo "å¼€å§‹ç¼–è¯‘å†…æ ¸ï¼ˆä½¿ç”¨ ${{ env.MAKE_JOBS }} ä¸ªCPUæ ¸å¿ƒï¼‰..."
          
          local start_time=$(date +%s)
          
          make -j${{ env.MAKE_JOBS }} \
            LLVM=${{ env.LLVM_VERSION }} \
            ARCH=${{ env.ARCH }} \
            CROSS_COMPILE=${{ env.CROSS_COMPILE }} \
            CC=${{ env.CC }} \
            LD=${{ env.LD }} \
            HOSTLD=${{ env.HOSTLD }} \
            RUSTC=${{ env.RUST_PATH }}/bin/rustc \
            PAHOLE=${{ env.PAHOLE_PATH }} \
            O=out \
            all 2>&1 | tee -a "${{ env.LOG_FILE }}"
          
          local end_time=$(date +%s)
          local duration=$((end_time - start_time))
          
          echo "ç¼–è¯‘è€—æ—¶: $((duration / 60)) åˆ† $((duration % 60)) ç§’"
          echo "$duration" > "${{ github.workspace }}/build-time.txt"
          
          # éªŒè¯ç¼–è¯‘è¾“å‡º
          if [ ! -f "out/arch/arm64/boot/Image" ]; then
            echo "âŒ é”™è¯¯: å†…æ ¸é•œåƒä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… å†…æ ¸ç¼–è¯‘å®Œæˆ"

      # ç¬¬16æ­¥ï¼šæ‰“åŒ…AnyKernel3
      - name: "ğŸ“¦ æ‰“åŒ…AnyKernel3åˆ·æœºåŒ…"
        if: ${{ env.SKIP_BUILD != 'true' }}
        run: |
          mkdir -p "${{ env.KERNEL_DIST }}"
          
          echo "å¤åˆ¶å†…æ ¸é•œåƒ..."
          cp "${{ env.KERNEL_OUT }}/arch/arm64/boot/Image" "${{ env.KERNEL_DIST }}/"
          
          echo "å…‹éš†AnyKernel3æ‰“åŒ…å·¥å…·..."
          cd "${{ env.KERNEL_DIST }}"
          
          if [ ! -d "AnyKernel3" ]; then
            git clone https://github.com/3620603660/AnyKernel3.git --depth=1 2>&1 | tee -a "${{ env.LOG_FILE }}"
          fi
          
          echo "æ¸…ç†AnyKernel3..."
          rm -rf AnyKernel3/.git AnyKernel3/push.sh
          
          echo "å¤åˆ¶å†…æ ¸é•œåƒåˆ°AnyKernel3..."
          cp Image AnyKernel3/
          
          if [ ! -f "AnyKernel3/Image" ]; then
            echo "âŒ é”™è¯¯: æ‰“åŒ…å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… å†…æ ¸æ‰“åŒ…å®Œæˆ"

      # ç¬¬17æ­¥ï¼šç”Ÿæˆç¼–è¯‘æŠ¥å‘Š
      - name: "ğŸ“Š ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š"
        if: always()
        run: |
          cat > "${{ env.BUILD_REPORT }}" <<'EOF'
          # OnePlus Ace5 Pro å†…æ ¸ç¼–è¯‘æŠ¥å‘Š
          
          ## ç¼–è¯‘ä¿¡æ¯
          - è®¾å¤‡: ${{ env.DEVICE_NAME }}
          - å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL_VERSION }}
          - ä¼˜åŒ–æ–¹æ¡ˆ: ${{ env.OPTIMIZATION_SCHEME }}
          - ç¼–è¯‘æ—¶é—´: $(date)
          
          ## ç¼–è¯‘é…ç½®
          - SUSFSè¡¥ä¸: ${{ env.APPLY_SUSFS_PATCH }}
          - Unicodeè¡¥ä¸: ${{ env.APPLY_UNICODE_PATCH }}
          - è°ƒåº¦å™¨è¡¥ä¸: ${{ env.APPLY_SCHED_PATCH }}
          
          ## ç¼–è¯‘ç»Ÿè®¡
          
          ### ccacheç»Ÿè®¡
          \`\`\`
          $(ccache -s 2>/dev/null || echo "ccacheæœªå¯ç”¨")
          \`\`\`
          
          ### ç¼–è¯‘è€—æ—¶
          $([ -f "${{ github.workspace }}/build-time.txt" ] && echo "$(cat "${{ github.workspace }}/build-time.txt") ç§’" || echo "æœªè®°å½•")
          
          ### å†…æ ¸å¤§å°
          $([ -f "${{ env.KERNEL_OUT }}/arch/arm64/boot/Image" ] && echo "$(stat -c%s "${{ env.KERNEL_OUT }}/arch/arm64/boot/Image") å­—èŠ‚" || echo "ç¼–è¯‘å¤±è´¥")
          
          ### ç£ç›˜ä½¿ç”¨
          \`\`\`
          $(df -h / | tail -1)
          \`\`\`
          
          ## ç¼–è¯‘æ—¥å¿—
          
          ### æœ€å100è¡Œæ—¥å¿—
          \`\`\`
          $(tail -100 "${{ env.LOG_FILE }}" 2>/dev/null || echo "æ—¥å¿—ä¸å¯ç”¨")
          \`\`\`
          
          EOF
          
          cat "${{ env.BUILD_REPORT }}"

      # ç¬¬18æ­¥ï¼šä¸Šä¼ ç¼–è¯‘ç»“æœ
      - name: "ğŸ“¤ ä¸Šä¼ ç¼–è¯‘ç»“æœ"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3_oneplus_ace5pro_${{ env.OPTIMIZATION_SCHEME }}
          path: ${{ env.KERNEL_DIST }}/AnyKernel3/*
          retention-days: 30

      # ç¬¬19æ­¥ï¼šä¸Šä¼ ç¼–è¯‘æŠ¥å‘Š
      - name: "ğŸ“¤ ä¸Šä¼ ç¼–è¯‘æŠ¥å‘Šå’Œæ—¥å¿—"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-report_${{ env.OPTIMIZATION_SCHEME }}
          path: |
            ${{ env.BUILD_REPORT }}
            ${{ env.LOG_FILE }}
            ${{ env.CCACHE_LOGFILE }}
          retention-days: 30

      # ç¬¬20æ­¥ï¼šæ˜¾ç¤ºæœ€ç»ˆç»Ÿè®¡
      - name: "ğŸ“Š æ˜¾ç¤ºæœ€ç»ˆç¼–è¯‘ç»Ÿè®¡"
        if: always()
        run: |
          cat <<'EOF'
          ========== ç¼–è¯‘å®Œæˆç»Ÿè®¡ ==========
          
          ccacheç»Ÿè®¡:
          EOF
          ccache -s 2>/dev/null || echo "ccacheæœªå¯ç”¨"
          
          cat <<'EOF'
          
          ç£ç›˜ä½¿ç”¨:
          EOF
          df -h / || true
          
          cat <<'EOF'
          
          ç¼–è¯‘ç»“æœ:
          EOF
          if [ -f "${{ env.KERNEL_DIST }}/AnyKernel3/Image" ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
            echo "å†…æ ¸å¤§å°: $(stat -c%s "${{ env.KERNEL_DIST }}/AnyKernel3/Image") å­—èŠ‚"
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
          fi
          
          cat <<'EOF'
          
          ================================
          EOF
