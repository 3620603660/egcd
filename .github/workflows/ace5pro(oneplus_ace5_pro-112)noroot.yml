name: ace5pro(kowsu)noroot
on:
  workflow_dispatch:
    inputs:
      CPU:
        description: "åˆ†æ”¯"
        required: true
        default: 'sm8750'
      FEIL:
        description: "é…ç½®æ–‡ä»¶"
        required: true
        default: 'oneplus_ace5_pro-112'
      ANDROID_VERSION:
        description: "å†…æ ¸å®‰å“ç‰ˆæœ¬"
        required: true
        default: 'android15'
      KERNEL_VERSION:
        description: "å†…æ ¸ç‰ˆæœ¬"
        required: true
        default: '6.6'
      KERNEL_NAME:
        description: "ä¿®æ”¹å†…æ ¸åç§°"
        required: true
        default: '-android15-8-g29d86c5fc9dd-abogki428889875'
      local_version:
        description: 'è¾“å…¥å†…æ ¸åç¼€åï¼ˆå¦‚-v8ï¼‰'
        required: false
        default: '-4k'
        type: string
      remove_default_4k:
        description: 'æ˜¯å¦åˆ é™¤é»˜è®¤çš„ -4k åç¼€ï¼Ÿï¼ˆå‹¾é€‰åˆ™åˆ é™¤ï¼‰'
        required: false
        default: false
        type: boolean
      kernel_time:
        description: 'å†…æ ¸æ„å»ºæ—¶é—´ï¼ˆUTC æ—¶é—´å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ "Mon May 12 09:09:59 UTC 2025"ï¼‰'
        required: false
        default: 'Tue Jul  1 19:48:18 UTC 2025'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CCACHE_DIR: /home/runner/.ccache
      CCACHE_MAXSIZE: 8G
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_BASEDIR: ${{ github.workspace }}
      CCACHE_LOGFILE: ${{ github.workspace }}/ccache.log
      TOKEN: ${{ secrets.TOKEN }}
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Configure Git & Install Dependencies
        run: |
          git config --global user.name "build"
          git config --global user.email "3620603668@qq.com"
          sudo apt-get update -qq
          sudo apt-get install -y python3 git curl ccache libelf-dev dos2unix

      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore ccache
        uses: actions/cache@v3
        with:
          path: /home/runner/.ccache
          key: ${{ runner.os }}-${{ github.repository }}-v2_noroot-112
          restore-keys: |
            ${{ runner.os }}-${{ github.repository }}-
            ${{ runner.os }}-
            ccache-

      - name: Setup build environment
        run: |
          echo "/usr/lib/ccache" >> $GITHUB_PATH
          export SOURCE_DATE_EPOCH=$(date -d "${{ github.event.inputs.kernel_time }}" +%s)
          echo "SOURCE_DATE_EPOCH=$SOURCE_DATE_EPOCH" >> $GITHUB_ENV
          ccache -s || true

      - name: Install repo tool
        run: |
          curl -s https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize repo and sync
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/3620603660/kernel_manifest.git -b refs/heads/oneplus/${{ github.event.inputs.CPU }} -m ${{ github.event.inputs.FEIL }}.xml --depth=1
          repo --trace sync -c -j$(nproc --all) --no-tags
          rm kernel_platform/common/android/abi_gki_protected_exports_* 2>/dev/null || true
          rm kernel_platform/msm-kernel/android/abi_gki_protected_exports_* 2>/dev/null || true

      - name: Apply kernel optimizations
        run: |
          cd kernel_workspace/kernel_platform
          cat <<'EOF' >> ./common/arch/arm64/configs/gki_defconfig

          # è°ƒåº¦ä¼˜åŒ–
          CONFIG_SCHED_EAS=y # èƒ½é‡æ„ŸçŸ¥è°ƒåº¦
          CONFIG_SCHED_EAS_PREFER_IDLE=y # ç©ºé—²ä¼˜å…ˆ
          CONFIG_SCHED_EAS_BOOST=y # æ€§èƒ½æå‡
          CONFIG_SCHED_TUNE=y # è°ƒåº¦è°ƒä¼˜
          CONFIG_SCHEDUTIL_CGROUP_DVFS=y # Cgroup DVFS
          CONFIG_SCHED_THERMAL_PRESSURE=y # çƒ­å‹åŠ›æ„ŸçŸ¥

          # I/O ä¼˜åŒ–
          CONFIG_BFQ_GROUP_IOSCHED=y # BFQ ç»„è°ƒåº¦
          CONFIG_BFQ_CGROUP_DEBUG=y # BFQ è°ƒè¯•
          CONFIG_BLK_CGROUP_IOCOST=y # I/O æˆæœ¬æ§åˆ¶
          CONFIG_BLK_CGROUP_IOLATENCY=y # I/O å»¶è¿Ÿæ§åˆ¶

          # CPU ç©ºé—²
          CONFIG_CPU_IDLE_MULTIPLE_DRIVERS=y # å¤šé©±åŠ¨æ”¯æŒ
          CONFIG_CPU_IDLE_GOV_HALTPOLL=y # Halt-poll è°ƒé€Ÿ
          CONFIG_CPU_IDLE_GOV_MENU=y # Menu è°ƒé€Ÿ
          CONFIG_CPU_IDLE_GOV_LADDER=y # Ladder è°ƒé€Ÿ

          # å†…å­˜ä¼˜åŒ–
          CONFIG_ZRAM=y # ZRAM å‹ç¼©
          CONFIG_ZRAM_MULTI_COMP=y # å¤šç®—æ³•æ”¯æŒ
          CONFIG_ZRAM_LZ4=y # LZ4 å‹ç¼©
          CONFIG_ZRAM_ZSTD=y # ZSTD å‹ç¼©
          CONFIG_ZRAM_WRITEBACK=y # ZRAM å†™å›

          # æ–‡ä»¶ç³»ç»Ÿ
          CONFIG_F2FS_FS_COMPRESSION=y # F2FS å‹ç¼©
          CONFIG_F2FS_FS_LZ4=y # F2FS LZ4
          CONFIG_F2FS_FS_ZSTD=y # F2FS ZSTD

          # çƒ­ç®¡ç†
          CONFIG_THERMAL_GOV_FAIR_SHARE=y # å…¬å¹³åˆ†äº«
          CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y # åŠŸç‡åˆ†é…
          CONFIG_THERMAL_GOV_STEP_WISE=y # åˆ†æ­¥æ§åˆ¶

          # ç½‘ç»œä¼˜åŒ–
          CONFIG_NET_SCH_CAKE=y # CAKE è°ƒåº¦
          CONFIG_NET_SCH_FQ_CODEL=y # FQ_CoDel è°ƒåº¦
          CONFIG_BQL=y # å­—èŠ‚é˜Ÿåˆ—é™åˆ¶

          # ç”µæºç®¡ç†
          CONFIG_PM_AUTOSLEEP=y # è‡ªåŠ¨ç¡çœ 
          CONFIG_PM_WAKELOCKS=y # å”¤é†’é”
          CONFIG_PM_GENERIC_DOMAINS=y # é€šç”¨ç”µæºåŸŸ

          EOF

          # ç§»é™¤ä¸å¿…è¦çš„é…ç½®æ£€æŸ¥
          sed -i 's/check_defconfig//' ./common/build.config.gki

          # æäº¤ä¼˜åŒ–é…ç½®
          cd common
          git add -A
          git commit -a -m "Optimize kernel: performance, latency, stability, power efficiency" || true

      - name: Configure kernel version and name
        run: |
          cd kernel_workspace/kernel_platform
          sed -i '208s|echo ".*"|echo "${KERNELVERSION}${scm_version}${config_localversion}"|' common/scripts/setlocalversion
          sed -i "s/\${scm_version}/${{ github.event.inputs.KERNEL_NAME }}/g" ./common/scripts/setlocalversion
          echo 'CONFIG_LOCALVERSION="${{ github.event.inputs.local_version }}"' >> ./common/arch/arm64/configs/gki_defconfig

      - name: Remove -4k suffix if requested
        if: ${{ fromJSON(github.event.inputs.remove_default_4k) }}
        run: |
          cd kernel_workspace/kernel_platform
          sed -i 's/-4k//' ./common/arch/arm64/configs/gki_defconfig

      - name: Download AFDO profile
        run: |
          cd kernel_workspace/kernel_platform/
          git clone https://github.com/PxxPei/afdo.git --depth=1

      - name: Set build timestamp
        run: |         
         export SOURCE_DATE_EPOCH=$(date -d "Tue Jul  1 19:48:18 UTC 2025" +%s)
         echo "SOURCE_DATE_EPOCH=$SOURCE_DATE_EPOCH" >> $GITHUB_ENV
   
      - name: Build Kernel
        run: |
         # ğŸ§© ä¸‹è½½å¹¶é…ç½® Clang 19.0.0gitï¼ˆä¿ç•™ç³»ç»Ÿ Clangï¼‰
         # ===============================

         # è¿›å…¥ clang é¢„ç¼–è¯‘ç›®å½•
         cd ${{ github.workspace }}/kernel_workspace/kernel_platform/prebuilts/clang/host/linux-x86
         
         echo "â¬‡ï¸ ä¸‹è½½ Clang 19.0.0git..."
         wget -q https://github.com/ZyCromerZ/Clang/releases/download/19.0.0git-20240723-release/Clang-19.0.0git-20240723.tar.gz

         echo "ğŸ“¦ è§£å‹ä¸­..."
         # è§£å‹åˆ°æŒ‡å®šç›®å½• clang-19.0.0git
         mkdir -p clang-19.0.0git
         tar -xf Clang-19.0.0git-20240723.tar.gz -C clang-19.0.0git

         echo "ğŸ“‚ è§£å‹åç›®å½•ç»“æ„ï¼š"
         ls -l clang-19.0.0git

         # å°†ä¸‹è½½çš„ Clang æ·»åŠ åˆ° PATHï¼ˆä¼˜å…ˆä½¿ç”¨ä¸‹è½½çš„ç‰ˆæœ¬ï¼‰
         export PATH="$(pwd)/clang-19.0.0git/bin:$PATH"

         # éªŒè¯ Clang ç‰ˆæœ¬æ˜¯å¦æ­£ç¡®åŠ è½½
         echo "ğŸ” å½“å‰ Clang ç‰ˆæœ¬ï¼š"
         clang --version || { echo "âŒ æœªæ‰¾åˆ° clangï¼Œè¯·æ£€æŸ¥ PATHï¼"; exit 1; }

         # éªŒè¯ clang ç‰ˆæœ¬æ˜¯å¦ä¸º 19 å¼€å¤´
         CLANG_VERSION=$(clang --version | head -n 1 | grep -o "19\.")
         if [ -z "$CLANG_VERSION" ]; then
            echo "âš ï¸ è­¦å‘Šï¼šå½“å‰ clang ç‰ˆæœ¬ä¸æ˜¯ 19.xï¼Œå¯èƒ½ PATH é…ç½®é”™è¯¯ï¼"
         fi

         echo "âœ… Clang ç¯å¢ƒé…ç½®å®Œæˆ"
         # å›åˆ°æºç ç›®å½•
         cd ${{ github.workspace }}/kernel_workspace/kernel_platform/common || { echo "âŒ æºç ç›®å½•ä¸å­˜åœ¨"; exit 1; }
         # åŒæ—¶åŠ å…¥ ccacheï¼ˆå¦‚æœå­˜åœ¨ï¼‰
         export PATH="/usr/lib/ccache:$PATH"

         # è®¾ç½®å›ºå®šå†…æ ¸æ„å»ºæ—¶é—´
         export KERNEL_TIME="Tue Jul  1 19:48:18 UTC 2025"
         export KBUILD_BUILD_TIMESTAMP="$KERNEL_TIME"
         export SOURCE_DATE_EPOCH=$(date -d "$KERNEL_TIME" +%s)
         # è®¾ç½® AFDO é…ç½®æ–‡ä»¶è·¯å¾„
         export AFDO_PROFILE="${{ github.workspace }}/kernel_workspace/kernel_platform/afdo/kernel.afdo"
         if [ ! -f "$AFDO_PROFILE" ]; then
           echo "Error: AFDO profile not found at $AFDO_PROFILE"
         exit 1
         fi

         # è®¾ç½®ä¸€äº›é€šç”¨å‚æ•°ï¼ˆä¾¿äºåç»­ç»´æŠ¤ï¼‰
         export KCFLAGS="-Wno-error -fauto-profile=$AFDO_PROFILE"
         export MAKE_ARGS="LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC=clang \
         RUSTC=../../prebuilts/rust/linux-x86/1.73.0b/bin/rustc \
         PAHOLE=../../prebuilts/kernel-build-tools/linux-x86/bin/pahole \
         LD=ld.lld HOSTLD=ld.lld O=out SOURCE_DATE_EPOCH=${SOURCE_DATE_EPOCH}"

         # è¿›å…¥æºç ç›®å½•
         cd ${{ github.workspace }}/kernel_workspace/kernel_platform/common || { echo "âŒ æºç ç›®å½•ä¸å­˜åœ¨"; exit 1; }
         rm -rf out

         # æ‰§è¡Œ defconfig
         export KBUILD_CFLAGS="-fpolly -flto=thin"
         make -j$(nproc) $MAKE_ARGS gki_defconfig

         # ç¼–è¯‘å…¨éƒ¨ç›®æ ‡
         make -j$(nproc) $MAKE_ARGS all

         # åˆ›å»ºè¾“å‡ºç›®å½•å¹¶å¤åˆ¶ Image
         mkdir -p ../dist
         cp out/arch/arm64/boot/Image ../dist/

      - name: Verify kernel build
        run: |
          strings kernel_workspace/kernel_platform/common/out/vmlinux | grep -i "UTC" || echo "Build timestamp verification completed"

      - name: Package AnyKernel3
        run: |
          cd kernel_workspace/kernel_platform/dist
          git clone https://github.com/3620603660/AnyKernel3.git AnyKernel3 --depth=1
          rm -rf AnyKernel3/.git AnyKernel3/push.sh
          cp Image AnyKernel3/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3_oneplus_ace5pro_${{ env.KSUVER }}_(kowsu)noroot
          path: kernel_workspace/kernel_platform/dist/AnyKernel3/*
