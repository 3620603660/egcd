name: ace5pro(oneplus_ace5_pro-112)noroot
on:
  workflow_dispatch:
    inputs:
      CPU:
        description: "åˆ†æ”¯"
        required: true
        default: 'sm8750'
      FEIL:
        description: "é…ç½®æ–‡ä»¶"
        required: true
        default: 'oneplus_ace5_pro'
      ANDROID_VERSION:
        description: "å†…æ ¸å®‰å“ç‰ˆæœ¬"
        required: true
        default: 'android15'
      KERNEL_VERSION:
        description: "å†…æ ¸ç‰ˆæœ¬"
        required: true
        default: '6.6'
      KERNEL_NAME:
        description: "ä¿®æ”¹å†…æ ¸åç§°"
        required: true
        default: '-android15-8-g29d86c5fc9dd-abogki428889875'
      local_version:
        description: 'è¾“å…¥å†…æ ¸åç¼€åï¼ˆå¦‚-v8ï¼‰'
        required: false
        default: '-4k'
        type: string
      remove_default_4k:
        description: 'æ˜¯å¦åˆ é™¤é»˜è®¤çš„ -4k åç¼€ï¼Ÿï¼ˆå‹¾é€‰åˆ™åˆ é™¤ï¼‰'
        required: false
        default: false
        type: boolean
      kernel_time:
        description: 'å†…æ ¸æ„å»ºæ—¶é—´ï¼ˆUTC æ—¶é—´å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ "Mon May 12 09:09:59 UTC 2025"ï¼‰'
        required: false
        default: 'Tue Jul  1 19:48:18 UTC 2025'
        type: string
      UNICODE_BYPASS:
        type: boolean
        description: "æ˜¯å¦æ·»åŠ Unicodeé›¶å®½ç»•è¿‡ä¿®å¤ä¸å†…å­˜ä¼˜åŒ–è¡¥ä¸ï¼Ÿ"
        required: true
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CCACHE_DIR: /home/runner/.ccache
      CCACHE_MAXSIZE: 8G
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_BASEDIR: ${{ github.workspace }}
      CCACHE_LOGFILE: ${{ github.workspace }}/ccache.log
      TOKEN: ${{ secrets.TOKEN }}
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Configure Git & Install Dependencies
        run: |
          git config --global user.name "build"
          git config --global user.email "3620603668@qq.com"
          sudo apt-get update -qq
          sudo apt-get install -y python3 git curl ccache libelf-dev dos2unix

      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore ccache
        uses: actions/cache@v3
        with:
          path: /home/runner/.ccache
          key: ${{ runner.os }}-${{ github.repository }}-v1_noroot
          restore-keys: |
            ${{ runner.os }}-${{ github.repository }}-
            ${{ runner.os }}-
            ccache-

      - name: Setup build environment
        run: |
          echo "/usr/lib/ccache" >> $GITHUB_PATH
          export SOURCE_DATE_EPOCH=$(date -d "${{ github.event.inputs.kernel_time }}" +%s)
          echo "SOURCE_DATE_EPOCH=$SOURCE_DATE_EPOCH" >> $GITHUB_ENV
          ccache -s || true

      - name: Install repo tool
        run: |
          curl -s https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize repo and sync
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/OnePlusOSS/kernel_manifest.git -b refs/heads/oneplus/${{ github.event.inputs.CPU }} -m ${{ github.event.inputs.FEIL }}.xml --depth=1
          repo --trace sync -c -j$(nproc --all) --no-tags
          rm kernel_platform/common/android/abi_gki_protected_exports_* 2>/dev/null || true
          rm kernel_platform/msm-kernel/android/abi_gki_protected_exports_* 2>/dev/null || true

      - name: Set up SUSFS & apply patches
        run: |
         set -e
         cd kernel_workspace
         git clone https://$TOKEN@github.com/3620603660/boot.git
         git clone https://github.com/3620603660/egcd.git
         cd kernel_platform
         cp ../boot/1.patch ./common/
         cd ./common
         patch -s -p1 -F 3 < 1.patch
         echo "âœ… SUSFS å’Œ boot patch åº”ç”¨å®Œæˆ"
         
      - name: Apply UNICODE_BYPASS and MEMORY_OPT
        if: ${{ github.event.inputs.UNICODE_BYPASS == 'true' }}
        run: |
          set -e
          cd kernel_workspace
          
          # å…‹éš†è¡¥ä¸ä»“åº“ï¼ˆå¦‚æœç›®å½•å·²å­˜åœ¨åˆ™è·³è¿‡ï¼‰
          if [ ! -d "Px" ]; then
            git clone https://$TOKEN@github.com/3620603660/Px.git
          fi
          
          PATCH_DIR="${{ github.workspace }}/kernel_workspace/Px/patches"
          cd kernel_platform/common
          
          # å®šä¹‰ä¸€ä¸ªå®‰å…¨çš„è¡¥ä¸åº”ç”¨å‡½æ•°
          apply_patch( ) {
            local patch_file=$1
            local patch_name=$(basename "$patch_file")
            echo "Checking patch: $patch_name"
            # ä½¿ç”¨ --dry-run -R æ£€æŸ¥è¡¥ä¸æ˜¯å¦å·²ç»åº”ç”¨è¿‡
            if patch -p1 --dry-run -R < "$patch_file" > /dev/null 2>&1; then
              echo "âœ… Patch $patch_name already applied, skipping."
            else
              echo "Applying patch: $patch_name"
              patch -p1 --forward < "$patch_file" || echo "âš ï¸ Warning: Failed to apply $patch_name, it might be partially applied or incompatible."
            fi
          }

          # åº”ç”¨å†…å­˜ä¼˜åŒ–è¡¥ä¸
          apply_patch "${PATCH_DIR}/optimized_mem_operations.patch"
          apply_patch "${PATCH_DIR}/file_struct_8bytes_align.patch"
          apply_patch "${PATCH_DIR}/reduce_cache_pressure.patch"
          
          # æ ¹æ®å†…æ ¸ç‰ˆæœ¬åº”ç”¨ Unicode ç»•è¿‡è¡¥ä¸
          KV_MAJOR=$(echo "${{ github.event.inputs.KERNEL_VERSION }}" | cut -d. -f1)
          
          if [ "$KV_MAJOR" -lt 6 ]; then
            apply_patch "${PATCH_DIR}/clear_page_16bytes_align.patch"
            echo "Patching unicode for 6.1-!"
            apply_patch "${PATCH_DIR}/unicode_bypass_fix_6.1-.patch"
          else
            # å¤„ç†ç‰¹æ®Šçš„ 6.1+ è¡¥ä¸é€»è¾‘
            if patch -p1 --dry-run -R < "${PATCH_DIR}/unicode_bypass_fix_6.1+.patch" > /dev/null 2>&1; then
              echo "âœ… Unicode bypass fix 6.1+ already applied, skipping."
            else
              echo "Applying Unicode bypass fix 6.1+..."
              cat "${PATCH_DIR}/clear_page_16bytes_align.patch" | sed -e 's/SYM_FUNC_START_PI(clear_page)/SYM_FUNC_START_PI(__pi_clear_page)/' | patch -p1 -F3 --forward || true
              patch -p1 --forward < "${PATCH_DIR}/unicode_bypass_fix_6.1+.patch" || true
            fi
          fi

      - name: Apply kernel optimizations
        run: |
          cd kernel_workspace/kernel_platform
          cat <<'EOF' >> ./common/arch/arm64/configs/gki_defconfig

          # æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ– - F2FS
          CONFIG_F2FS_FS_COMPRESSION=y
          CONFIG_F2FS_FS_LZ4=y
          CONFIG_F2FS_FS_ZSTD=y
          CONFIG_F2FS_IO_QUEUE_ENHANCEMENT=y
          CONFIG_F2FS_IO_LATENCY_ENHANCEMENT=y
          CONFIG_F2FS_ATOMIC_WRITE=y
          CONFIG_F2FS_IOSTAT=y
          CONFIG_F2FS_FS_COMPRESSION_EXTENSION=y

          # CPU å’Œç”µæºç®¡ç† - æ ¸å¿ƒä¼˜åŒ–
          CONFIG_CPU_FREQ=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_STAT=y
          CONFIG_CPU_HOTPLUG=y
          CONFIG_CPU_IDLE=y
          CONFIG_CPU_IDLE_GOV_TEO=y
          CONFIG_CPU_IDLE_STATE_RESIDENCY=y
          CONFIG_CPU_IDLE_MULTIPLE_DRIVERS=y
          CONFIG_CPU_IDLE_GOV_HALTPOLL=y
          CONFIG_PM_DOMAIN_CPU_GOV=y
          CONFIG_PM_WAKELOCKS=y
          CONFIG_PM_WAKELOCKS_GC=y
          CONFIG_SCHED_CORE=y
          CONFIG_SCHED_EAS=y
          CONFIG_SCHED_EAS_PREFER_IDLE=y
          CONFIG_SCHED_EAS_BOOST=y
          CONFIG_SCHED_HRTICK=y
          CONFIG_SCHED_MC=y
          CONFIG_SCHED_THERMAL_PRESSURE=y
          CONFIG_SCHED_TUNE=y
          CONFIG_SCHED_UTIL_CLAMP=y
          CONFIG_SCHED_WALT=y
          CONFIG_THERMAL_GOV_FAIR_SHARE=y
          CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y
          CONFIG_UCLAMP_TASK=y

          # å¯ç”¨å‹ç¼©ç®—æ³•æ”¯æŒ
          CONFIG_CRYPTO_LZ4HC=y
          CONFIG_CRYPTO_LZ4K=y
          CONFIG_CRYPTO_LZ4KD=y
          CONFIG_CRYPTO_842=y

          # å†…å­˜ç®¡ç† - ä¼˜åŒ–
          CONFIG_ION=y
          CONFIG_MEMCG=y
          CONFIG_LRU_GEN=y
          CONFIG_TRANSPARENT_HUGEPAGE=y
          CONFIG_TRANSPARENT_HUGEPAGE_MADVISE=y
          CONFIG_ZRAM=y
          CONFIG_ZRAM_LZ4=y
          CONFIG_ZRAM_MULTI_COMP=y
          CONFIG_ZRAM_ZSTD=y
          CONFIG_ZSMALLOC=y
          CONFIG_MEMORY_HOTPLUG=y
          CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE=y

          # ç½‘ç»œä¼˜åŒ– - ç²¾é€‰é…ç½®
          CONFIG_BQL=y
          CONFIG_DEFAULT_NET_SCH="cake"
          CONFIG_NET_SCH_CAKE=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_NET_SCH_FQ_CODEL=y
          CONFIG_DEFAULT_TCP_CONG="bbr"
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_TCP_CONG_CUBIC=y
          CONFIG_TCP_FASTOPEN=y
          CONFIG_TCP_SACK=y
          CONFIG_TCP_TIMESTAMPS=y
          CONFIG_INET=y
          CONFIG_IPV6=y

          # I/O è°ƒåº¦ - æ€§èƒ½ä¼˜åŒ–
          CONFIG_MQ_IOSCHED_BFQ=y
          CONFIG_BFQ_GROUP_IOSCHED=y
          CONFIG_BFQ_CGROUP_DEBUG=y
          CONFIG_BLK_CGROUP_IOCOST=y
          CONFIG_BLK_MQ=y
          CONFIG_BLK_WBT=y
          CONFIG_IO_URING=y

          # ç¼–è¯‘ä¼˜åŒ–
          CONFIG_LTO_CLANG=y
          CONFIG_LTO_CLANG_THIN=y
          CONFIG_LTO_POLLY=y

          # æ–‡ä»¶ç³»ç»Ÿç‰¹æ€§
          CONFIG_TMPFS_POSIX_ACL=y
          CONFIG_TMPFS_XATTR=y

          EOF

          # ç§»é™¤ä¸å¿…è¦çš„é…ç½®æ£€æŸ¥
          sed -i 's/check_defconfig//' ./common/build.config.gki

          # æäº¤ä¼˜åŒ–é…ç½®
          cd common
          git add -A
          git commit -a -m "Optimize kernel: performance, latency, stability, power efficiency" || true

      - name: Configure kernel version and name
        run: |
          cd kernel_workspace/kernel_platform
          sed -i '208s|echo ".*"|echo "${KERNELVERSION}${scm_version}${config_localversion}"|' common/scripts/setlocalversion
          sed -i "s/\${scm_version}/${{ github.event.inputs.KERNEL_NAME }}/g" ./common/scripts/setlocalversion
          echo 'CONFIG_LOCALVERSION="${{ github.event.inputs.local_version }}"' >> ./common/arch/arm64/configs/gki_defconfig

      - name: Remove -4k suffix if requested
        if: ${{ fromJSON(github.event.inputs.remove_default_4k) }}
        run: |
          cd kernel_workspace/kernel_platform
          sed -i 's/-4k//' ./common/arch/arm64/configs/gki_defconfig

      - name: Download AFDO profile
        run: |
          cd kernel_workspace/kernel_platform/
          git clone https://github.com/PxxPei/afdo.git --depth=1

      - name: Build Kernel
        run: |
         # ğŸ§© ä¸‹è½½å¹¶é…ç½® Clang 19.0.0gitï¼ˆä¿ç•™ç³»ç»Ÿ Clangï¼‰
         # ===============================

         # è¿›å…¥ clang é¢„ç¼–è¯‘ç›®å½•
         cd ${{ github.workspace }}/kernel_workspace/kernel_platform/prebuilts/clang/host/linux-x86
         
         echo "â¬‡ï¸ ä¸‹è½½ Clang 19.0.0git..."
         wget -q https://github.com/ZyCromerZ/Clang/releases/download/19.0.0git-20240723-release/Clang-19.0.0git-20240723.tar.gz

         echo "ğŸ“¦ è§£å‹ä¸­..."
         # è§£å‹åˆ°æŒ‡å®šç›®å½• clang-19.0.0git
         mkdir -p clang-19.0.0git
         tar -xf Clang-19.0.0git-20240723.tar.gz -C clang-19.0.0git

         echo "ğŸ“‚ è§£å‹åç›®å½•ç»“æ„ï¼š"
         ls -l clang-19.0.0git

         # å°†ä¸‹è½½çš„ Clang æ·»åŠ åˆ° PATHï¼ˆä¼˜å…ˆä½¿ç”¨ä¸‹è½½çš„ç‰ˆæœ¬ï¼‰
         export PATH="$(pwd)/clang-19.0.0git/bin:$PATH"

         # éªŒè¯ Clang ç‰ˆæœ¬æ˜¯å¦æ­£ç¡®åŠ è½½
         echo "ğŸ” å½“å‰ Clang ç‰ˆæœ¬ï¼š"
         clang --version || { echo "âŒ æœªæ‰¾åˆ° clangï¼Œè¯·æ£€æŸ¥ PATHï¼"; exit 1; }

         # éªŒè¯ clang ç‰ˆæœ¬æ˜¯å¦ä¸º 19 å¼€å¤´
         CLANG_VERSION=$(clang --version | head -n 1 | grep -o "19\.")
         if [ -z "$CLANG_VERSION" ]; then
            echo "âš ï¸ è­¦å‘Šï¼šå½“å‰ clang ç‰ˆæœ¬ä¸æ˜¯ 19.xï¼Œå¯èƒ½ PATH é…ç½®é”™è¯¯ï¼"
         fi

         echo "âœ… Clang ç¯å¢ƒé…ç½®å®Œæˆ"
         # å›åˆ°æºç ç›®å½•
         cd ${{ github.workspace }}/kernel_workspace/kernel_platform/common || { echo "âŒ æºç ç›®å½•ä¸å­˜åœ¨"; exit 1; }
         # åŒæ—¶åŠ å…¥ ccacheï¼ˆå¦‚æœå­˜åœ¨ï¼‰
         export PATH="/usr/lib/ccache:$PATH"

         # è®¾ç½®å›ºå®šå†…æ ¸æ„å»ºæ—¶é—´
         export KERNEL_TIME="Tue Jul  1 19:48:18 UTC 2025"
         export KBUILD_BUILD_TIMESTAMP="$KERNEL_TIME"
         export SOURCE_DATE_EPOCH=$(date -d "$KERNEL_TIME" +%s)
         # è®¾ç½® AFDO é…ç½®æ–‡ä»¶è·¯å¾„
         export AFDO_PROFILE="${{ github.workspace }}/kernel_workspace/kernel_platform/afdo/kernel.afdo"
         if [ ! -f "$AFDO_PROFILE" ]; then
           echo "Error: AFDO profile not found at $AFDO_PROFILE"
         exit 1
         fi

         # è®¾ç½®ä¸€äº›é€šç”¨å‚æ•°ï¼ˆä¾¿äºåç»­ç»´æŠ¤ï¼‰
         export KCFLAGS="-Wno-error -fauto-profile=$AFDO_PROFILE"
         export MAKE_ARGS="LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC=clang \
         RUSTC=../../prebuilts/rust/linux-x86/1.73.0b/bin/rustc \
         PAHOLE=../../prebuilts/kernel-build-tools/linux-x86/bin/pahole \
         LD=ld.lld HOSTLD=ld.lld O=out SOURCE_DATE_EPOCH=${SOURCE_DATE_EPOCH}"

         # è¿›å…¥æºç ç›®å½•
         cd ${{ github.workspace }}/kernel_workspace/kernel_platform/common || { echo "âŒ æºç ç›®å½•ä¸å­˜åœ¨"; exit 1; }
         rm -rf out

         # æ‰§è¡Œ defconfig
         export KBUILD_CFLAGS="-fpolly -flto=thin"
         make -j$(nproc) $MAKE_ARGS gki_defconfig

         # ç¼–è¯‘å…¨éƒ¨ç›®æ ‡
         make -j$(nproc) $MAKE_ARGS all

         # åˆ›å»ºè¾“å‡ºç›®å½•å¹¶å¤åˆ¶ Image
         mkdir -p ../dist
         cp out/arch/arm64/boot/Image ../dist/

      - name: Verify kernel build
        run: |
          strings kernel_workspace/kernel_platform/common/out/vmlinux | grep -i "UTC" || echo "Build timestamp verification completed"

      - name: Package AnyKernel3
        run: |
          cd kernel_workspace/kernel_platform/dist
          git clone https://github.com/3620603660/AnyKernel3.git AnyKernel3 --depth=1
          rm -rf AnyKernel3/.git AnyKernel3/push.sh
          cp Image AnyKernel3/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3_oneplus_ace5pro_${{ env.KSUVER }}_(kowsu)noroot
          path: kernel_workspace/kernel_platform/dist/AnyKernel3/*
