name: ace5pro(kowsu)noroot
on:
  workflow_dispatch:
    inputs:
      CPU:
        description: "ÂàÜÊîØ"
        required: true
        default: 'sm8750'
      FEIL:
        description: "ÈÖçÁΩÆÊñá‰ª∂"
        required: true
        default: 'oneplus_ace5_pro-112'
      ANDROID_VERSION:
        description: "ÂÜÖÊ†∏ÂÆâÂçìÁâàÊú¨"
        required: true
        default: 'android15'
      KERNEL_VERSION:
        description: "ÂÜÖÊ†∏ÁâàÊú¨"
        required: true
        default: '6.6'
      KERNEL_NAME:
        description: "‰øÆÊîπÂÜÖÊ†∏ÂêçÁß∞"
        required: true
        default: '-android15-8-g29d86c5fc9dd-abogki428889875'
      local_version:
        description: 'ËæìÂÖ•ÂÜÖÊ†∏ÂêéÁºÄÂêçÔºàÂ¶Ç-v8Ôºâ'
        required: false
        default: '-4k'
        type: string
      remove_default_4k:
        description: 'ÊòØÂê¶Âà†Èô§ÈªòËÆ§ÁöÑ -4k ÂêéÁºÄÔºüÔºàÂãæÈÄâÂàôÂà†Èô§Ôºâ'
        required: false
        default: false
        type: boolean
      kernel_time:
        description: 'ÂÜÖÊ†∏ÊûÑÂª∫Êó∂Èó¥ÔºàUTC Êó∂Èó¥Â≠óÁ¨¶‰∏≤Ôºå‰æãÂ¶Ç "Mon May 12 09:09:59 UTC 2025"Ôºâ'
        required: false
        default: 'Tue Jul  1 19:48:18 UTC 2025'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CCACHE_DIR: /home/runner/.ccache
      CCACHE_MAXSIZE: 8G
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_BASEDIR: ${{ github.workspace }}
      CCACHE_LOGFILE: ${{ github.workspace }}/ccache.log
      TOKEN: ${{ secrets.TOKEN }}
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Configure Git & Install Dependencies
        run: |
          git config --global user.name "build"
          git config --global user.email "3620603668@qq.com"
          sudo apt-get update -qq
          sudo apt-get install -y python3 git curl ccache libelf-dev dos2unix

      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore ccache
        uses: actions/cache@v3
        with:
          path: /home/runner/.ccache
          key: ${{ runner.os }}-${{ github.repository }}-v2_noroot-112
          restore-keys: |
            ${{ runner.os }}-${{ github.repository }}-
            ${{ runner.os }}-
            ccache-

      - name: Setup build environment
        run: |
          echo "/usr/lib/ccache" >> $GITHUB_PATH
          export SOURCE_DATE_EPOCH=$(date -d "${{ github.event.inputs.kernel_time }}" +%s)
          echo "SOURCE_DATE_EPOCH=$SOURCE_DATE_EPOCH" >> $GITHUB_ENV
          ccache -s || true

      - name: Install repo tool
        run: |
          curl -s https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize repo and sync
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/3620603660/kernel_manifest.git -b refs/heads/oneplus/${{ github.event.inputs.CPU }} -m ${{ github.event.inputs.FEIL }}.xml --depth=1
          repo --trace sync -c -j$(nproc --all) --no-tags
          rm kernel_platform/common/android/abi_gki_protected_exports_* 2>/dev/null || true
          rm kernel_platform/msm-kernel/android/abi_gki_protected_exports_* 2>/dev/null || true

      - name: Apply kernel optimizations
        run: |
          cd kernel_workspace/kernel_platform
          cat <<'EOF' >> ./common/arch/arm64/configs/gki_defconfig

          # Ë∞ÉÂ∫¶‰ºòÂåñ
          CONFIG_SCHED_EAS=y # ËÉΩÈáèÊÑüÁü•Ë∞ÉÂ∫¶
          CONFIG_SCHED_EAS_PREFER_IDLE=y # Á©∫Èó≤‰ºòÂÖà
          CONFIG_SCHED_EAS_BOOST=y # ÊÄßËÉΩÊèêÂçá
          CONFIG_SCHED_TUNE=y # Ë∞ÉÂ∫¶Ë∞É‰ºò
          CONFIG_SCHEDUTIL_CGROUP_DVFS=y # Cgroup DVFS
          CONFIG_SCHED_THERMAL_PRESSURE=y # ÁÉ≠ÂéãÂäõÊÑüÁü•

          # I/O ‰ºòÂåñ
          CONFIG_BFQ_GROUP_IOSCHED=y # BFQ ÁªÑË∞ÉÂ∫¶
          CONFIG_BFQ_CGROUP_DEBUG=y # BFQ Ë∞ÉËØï
          CONFIG_BLK_CGROUP_IOCOST=y # I/O ÊàêÊú¨ÊéßÂà∂
          CONFIG_BLK_CGROUP_IOLATENCY=y # I/O Âª∂ËøüÊéßÂà∂

          # CPU Á©∫Èó≤
          CONFIG_CPU_IDLE_MULTIPLE_DRIVERS=y # Â§öÈ©±Âä®ÊîØÊåÅ
          CONFIG_CPU_IDLE_GOV_HALTPOLL=y # Halt-poll Ë∞ÉÈÄü
          CONFIG_CPU_IDLE_GOV_MENU=y # Menu Ë∞ÉÈÄü
          CONFIG_CPU_IDLE_GOV_LADDER=y # Ladder Ë∞ÉÈÄü

          # ÂÜÖÂ≠ò‰ºòÂåñ
          CONFIG_ZRAM=y # ZRAM ÂéãÁº©
          CONFIG_ZRAM_MULTI_COMP=y # Â§öÁÆóÊ≥ïÊîØÊåÅ
          CONFIG_ZRAM_LZ4=y # LZ4 ÂéãÁº©
          CONFIG_ZRAM_ZSTD=y # ZSTD ÂéãÁº©
          CONFIG_ZRAM_WRITEBACK=y # ZRAM ÂÜôÂõû

          # Êñá‰ª∂Á≥ªÁªü
          CONFIG_F2FS_FS_COMPRESSION=y # F2FS ÂéãÁº©
          CONFIG_F2FS_FS_LZ4=y # F2FS LZ4
          CONFIG_F2FS_FS_ZSTD=y # F2FS ZSTD

          # ÁÉ≠ÁÆ°ÁêÜ
          CONFIG_THERMAL_GOV_FAIR_SHARE=y # ÂÖ¨Âπ≥ÂàÜ‰∫´
          CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y # ÂäüÁéáÂàÜÈÖç
          CONFIG_THERMAL_GOV_STEP_WISE=y # ÂàÜÊ≠•ÊéßÂà∂

          # ÁΩëÁªú‰ºòÂåñ
          CONFIG_NET_SCH_CAKE=y # CAKE Ë∞ÉÂ∫¶
          CONFIG_NET_SCH_FQ_CODEL=y # FQ_CoDel Ë∞ÉÂ∫¶
          CONFIG_BQL=y # Â≠óËäÇÈòüÂàóÈôêÂà∂

          # ÁîµÊ∫êÁÆ°ÁêÜ
          CONFIG_PM_AUTOSLEEP=y # Ëá™Âä®Áù°Áú†
          CONFIG_PM_WAKELOCKS=y # Âî§ÈÜíÈîÅ
          CONFIG_PM_GENERIC_DOMAINS=y # ÈÄöÁî®ÁîµÊ∫êÂüü

          # Á®≥ÂÆöÊÄß‰∏éÂÆâÂÖ®
          CONFIG_HARDENED_USERCOPY=y # Áî®Êà∑Â§çÂà∂Âä†Âõ∫
          CONFIG_FORTIFY_SOURCE=y # Ê∫êÁ†ÅÂä†Âõ∫
          CONFIG_HARDENED_USERCOPY_FALLBACK=y # Â§çÂà∂ÂõûÈÄÄÂä†Âõ∫
          CONFIG_STACKPROTECTOR=y # Ê†à‰øùÊä§
          CONFIG_STACKPROTECTOR_STRONG=y # Âº∫Ê†à‰øùÊä§
          CONFIG_HAVE_STACKPROTECTOR=y # Êû∂ÊûÑÊ†à‰øùÊä§
          CONFIG_HAVE_STACKPROTECTOR_SYSREG=y # ÂØÑÂ≠òÂô®Ê†à‰øùÊä§


          EOF

          # ÁßªÈô§‰∏çÂøÖË¶ÅÁöÑÈÖçÁΩÆÊ£ÄÊü•
          sed -i 's/check_defconfig//' ./common/build.config.gki

          # Êèê‰∫§‰ºòÂåñÈÖçÁΩÆ
          cd common
          git add -A
          git commit -a -m "Optimize kernel: performance, latency, stability, power efficiency" || true

      - name: Configure kernel version and name
        run: |
          cd kernel_workspace/kernel_platform
          sed -i '208s|echo ".*"|echo "${KERNELVERSION}${scm_version}${config_localversion}"|' common/scripts/setlocalversion
          sed -i "s/\${scm_version}/${{ github.event.inputs.KERNEL_NAME }}/g" ./common/scripts/setlocalversion
          echo 'CONFIG_LOCALVERSION="${{ github.event.inputs.local_version }}"' >> ./common/arch/arm64/configs/gki_defconfig

      - name: Remove -4k suffix if requested
        if: ${{ fromJSON(github.event.inputs.remove_default_4k) }}
        run: |
          cd kernel_workspace/kernel_platform
          sed -i 's/-4k//' ./common/arch/arm64/configs/gki_defconfig

      - name: Download AFDO profile
        run: |
          cd kernel_workspace/kernel_platform/
          git clone https://github.com/PxxPei/afdo.git --depth=1

      - name: Build kernel with optimizations
        run: |
          cd ${{ github.workspace }}/kernel_workspace/kernel_platform/prebuilts/clang/host/linux-x86

          echo "‚¨áÔ∏è Downloading Clang 19.0.0git..."
          wget -q https://github.com/ZyCromerZ/Clang/releases/download/19.0.0git-20240723-release/Clang-19.0.0git-20240723.tar.gz

          echo "üì¶ Extracting Clang..."
          mkdir -p clang-19.0.0git
          tar -xf Clang-19.0.0git-20240723.tar.gz -C clang-19.0.0git --strip-components=1

          export PATH="$(pwd)/clang-19.0.0git/bin:/usr/lib/ccache:$PATH"
          export KERNEL_TIME="${{ github.event.inputs.kernel_time }}"
          export KBUILD_BUILD_TIMESTAMP="$KERNEL_TIME"
          export SOURCE_DATE_EPOCH=$(date -d "$KERNEL_TIME" +%s)

          cd ${{ github.workspace }}/kernel_workspace/kernel_platform/common

          # Verify AFDO profile
          AFDO_PROFILE="${{ github.workspace }}/kernel_workspace/kernel_platform/afdo/kernel.afdo"
          if [ ! -f "$AFDO_PROFILE" ]; then
            echo "Error: AFDO profile not found"
            exit 1
          fi

          # Optimized build flags
          export KCFLAGS="-fauto-profile=$AFDO_PROFILE"
          export MAKE_ARGS="LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC=clang \
            RUSTC=../../prebuilts/rust/linux-x86/1.73.0b/bin/rustc \
            PAHOLE=../../prebuilts/kernel-build-tools/linux-x86/bin/pahole \
            LD=ld.lld HOSTLD=ld.lld O=out SOURCE_DATE_EPOCH=${SOURCE_DATE_EPOCH}"

          rm -rf out

          # Compile with optimizations
          export KBUILD_CFLAGS="-fpolly -flto=thin -march=native"
          make -j$(nproc) $MAKE_ARGS gki_defconfig
          make -j$(nproc) $MAKE_ARGS all

          # Prepare output
          mkdir -p ../dist
          cp out/arch/arm64/boot/Image ../dist/

      - name: Verify kernel build
        run: |
          strings kernel_workspace/kernel_platform/common/out/vmlinux | grep -i "UTC" || echo "Build timestamp verification completed"

      - name: Package AnyKernel3
        run: |
          cd kernel_workspace/kernel_platform/dist
          git clone https://github.com/3620603660/AnyKernel3.git AnyKernel3 --depth=1
          rm -rf AnyKernel3/.git AnyKernel3/push.sh
          cp Image AnyKernel3/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3_oneplus_ace5pro_${{ env.KSUVER }}_(kowsu)noroot
          path: kernel_workspace/kernel_platform/dist/AnyKernel3/*
